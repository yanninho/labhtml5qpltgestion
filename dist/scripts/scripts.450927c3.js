"use strict";angular.module("quiprendlesticketsGestionApp",["ngAnimate","ngCookies","ngMessages","ngResource","ngRoute","ngSanitize","ngTouch","ui.grid","ui.grid.selection","ui.grid.resizeColumns","ui.grid.infiniteScroll","config","http-auth-interceptor","ui.bootstrap"]).config(["$routeProvider","$locationProvider","$httpProvider",function(a,b,c){c.defaults.useXDomain=!0,c.defaults.withCredentials=!0,delete c.defaults.headers.common["X-Requested-With"],a.when("/nouveauxCommentaires",{templateUrl:"views/nouveauxcommentaires.html",controller:"NouveauxcommentairesCtrl"}).when("/signalements",{templateUrl:"views/signalements.html",controller:"SignalementsCtrl"}).when("/signup",{templateUrl:"views/signup.html",controller:"SignupCtrl"}).when("/login",{templateUrl:"views/login.html",controller:"LoginCtrl"}).when("/magasins",{templateUrl:"views/magasins.html",controller:"MagasinsCtrl"}).otherwise({redirectTo:"/"}),b.html5Mode(!0)}]).run(["$rootScope","$location","Auth",function(a,b,c){a.$watch("currentUser",function(a){a||-1!=["/login","/logout","/signup"].indexOf(b.path())||c.currentUser()}),a.$on("event:auth-loginRequired",function(){return b.path("/login"),!1})}]),angular.module("config",[]).constant("ENV",{name:"production",urlStatics:"http://labhtml5qpltbackend.herokuapp.com/static",urlBackend:"http://labhtml5qpltbackend.herokuapp.com"}),angular.module("quiprendlesticketsGestionApp").controller("NouveauxcommentairesCtrl",["$scope","commentaireService","modalites","messageService",function(a,b,c,d){a.commentaires=b.getCommentaires(),a.commentaires.multiSelect=!0,a.commentaires.enableSorting=!1,a.commentaires.columnDefs=[{name:"Date",field:"date",type:"date",cellFilter:'date:"dd-MM-yyyy"'},{name:"Modalité",cellClass:function(a,b){return c[b.entity.modalite.nom]}},{name:"Texte",field:"texte"}],a.commentaires.rowHeight=60;var e=function(a){a.selected=angular.isUndefined(a.selected)?!0:!a.selected};a.commentaires.onRegisterApi=function(b){a.gridApi=b,b.selection.on.rowSelectionChanged(a,function(a){e(a.entity)}),b.selection.on.rowSelectionChangedBatch(a,function(a){a.forEach(function(a){e(a.entity)})})},a.activeCommentaires=function(){var a=b.activeCommentaires();a.then(function(){d.setMessage({texte:"Les commentaires ont été activés avec succès",type:"message-valid",icon:null})},function(a){d.setMessage({texte:"Erreur lors de la tentative pour l'activation des commentaires : "+a,type:"message-error",icon:null})},function(a){d.setMessage({texte:a,type:null,icon:null})})}}]),angular.module("quiprendlesticketsGestionApp").factory("commentaireService",["$q","restService","ENV",function(a,b,c){var d={data:[]},e=function(){if(0==d.data.length){var a=b.getAppel({method:"GET",url:c.urlBackend+"/commentaires"});a.then(function(a){d.data=a.data})}};return{getCommentaires:function(){return e(),d},activeCommentaires:function(){var f=null,g=[];if(d.data.forEach(function(a){var b=a.selected;b&&g.push(a)}),g.length>0){var h=b.getAppel({method:"POST",url:c.urlBackend+"/magasins/commentaires",data:{commentaires:g}});f=h.then(function(){d.data=[],e()})}else{var i=a.defer();i.reject("Veuillez sélectionner au moins un commentaire à valider"),f=i.promise}return f}}}]),angular.module("quiprendlesticketsGestionApp").factory("restService",["$q","$http",function(a,b){var c=a.when("start");return{getAppel:function(d){var e=c.then(function(){return b(d).success(function(a){return a}).error(function(){return a.reject()})});return e}}}]),angular.module("quiprendlesticketsGestionApp").controller("SignalementsCtrl",["$scope","signalementService","marques","messageService",function(a,b,c,d){a.signalements=b.getSignalements(),a.signalements.multiSelect=!0,a.signalements.enableSorting=!1,a.signalements.columnDefs=[{name:"Date",field:"date",type:"date",cellFilter:'date:"dd-MM-yyyy"'},{name:"Raison",field:"erreur",cellFilter:"raisonSignalement"},{name:"Explication",field:"explication",cellClass:"cellLongText"},{name:"Adresse",field:"magasin.adresse"},{name:"carte",displayName:"Carte",cellTemplate:'<div class="ui-grid-cell-contents cell-adresse"><img ng-src="https://maps.googleapis.com/maps/api/staticmap?center=46.52863469527167,2.43896484375&zoom=4&size=200x200&markers=color:red%7Clabel:%7C{{row.entity.magasin.location[1]}},{{row.entity.magasin.location[0]}}" lazy-src></div>'},{name:"Marque",cellClass:function(a,b){return c[b.entity.magasin.marque.nom]+" marque"}},{name:"Activé sur la carte",field:"magasin.actif",cellFilter:"ouinon"}],a.signalements.rowHeight=200;var e=function(a){a.selected=angular.isUndefined(a.selected)?!0:!a.selected};a.signalements.onRegisterApi=function(b){a.gridApi=b,b.selection.on.rowSelectionChanged(a,function(a){e(a.entity)}),b.selection.on.rowSelectionChangedBatch(a,function(a){a.forEach(function(a){e(a.entity)})})},a.desactiverMagasins=function(){var a=b.desactiverMagasins();a.then(function(){d.setMessage({texte:"Les magasins ont été désactivés avec succès",type:"message-valid",icon:null})},function(a){d.setMessage({texte:"Erreur lors de la tentative de désactivation des magasins : "+a,type:"message-error",icon:null})},function(a){d.setMessage({texte:a,type:null,icon:null})})}}]),angular.module("quiprendlesticketsGestionApp").factory("signalementService",["restService","ENV",function(a,b){var c={data:[]},d=function(){if(0==c.data.length){var d=a.getAppel({method:"GET",url:b.urlBackend+"/signalements"});d.then(function(a){c.data=a.data})}};return{getSignalements:function(){return d(),c},desactiverMagasins:function(){var e=null,f=[];if(c.data.forEach(function(a){var b=a.selected;b&&f.push(a)}),f.length>0){var g=a.getAppel({method:"POST",url:b.urlBackend+"/magasins/activer/non",data:{signalements:f}});e=g.then(function(){c.data=[],d()})}else{var h=$q.defer();h.reject("Veuillez sélectionner au moins un magasin à désactiver"),e=h.promise}return e}}}]),angular.module("quiprendlesticketsGestionApp").filter("raisonSignalement",function(){return function(a){var b=[];b.EXISTE_PAS="Ce magasin n'existe peut-être plus.",b.FERME="Ce magasin a fermé ses portes",b.ADRESSE_INCORRECTE="L'adresse est incorrecte";var c=b[a];return angular.isUndefined(c)&&(c=""),c}}),angular.module("quiprendlesticketsGestionApp").filter("ouinon",function(){return function(a,b){var c="non";return a&&(c="oui"),b&&(c=c.toUpperCase()),c}});var modalites=[];modalites["Tickets restaurants"]="ticketRestaurant",modalites["Cheques de table"]="chequeDeTable",modalites["Cheques dejeuner"]="chequesDejeuner",modalites["Cheques restaurants"]="chequeRestaurant",angular.module("quiprendlesticketsGestionApp").constant("modalites",modalites);var marques=[];marques["Leader Price"]="Leader_Price",marques["Casino Supermarchés"]="casino",marques.Auchan="auchan",marques.Carrefour="carrefour",marques["E.Leclerc"]="leclerc",marques["Géant Casino"]="geant_casino",marques["Hyper U"]="hyperU",marques["Intermarché Hyper"]="intermarches_hyper",marques.Match="match",marques["Maxi Coop"]="maxi_coop",marques["Carrefour Market"]="carrefour_market",marques.Colruyt="colruyt",marques["Intermarché Super"]="intermarche_super",marques["Super U"]="superU",marques["Simply Market"]="simply_market",marques.Biocoop="biocoop",marques["Carrefour Contact"]="carrefour_contact",marques.Coccinelle="coccinelle",marques.Diagonal="diagonal",marques["Intermarché Contact"]="intermarches_contact",marques["Maximarché"]="maximarche",marques.Migros="migros",marques.Monoprix="monoprix",marques["Supermarché Maxi"]="maxi",marques["Supermarché Sitis"]="sitis",marques["8 à huit"]="8ahuit",marques["Carrefour Montagne"]="carrefour",marques["Cocci Market"]="cocci_market",marques["Supermarché Match"]="match",marques["Point Coop"]="point_coop",marques.Proxi="Proxi",marques.Schlecker="Schlecker",marques.Sherpa="Sherpa",marques.Spar="SPAR",marques.Utile="U",marques.Vival="vival",marques.Viveco="viveco",marques["Carrefour City"]="carrefour_city",marques["Carrefour Express"]="carrefour_express",marques["E.Leclerc Express"]="Eleclerc",marques.Franprix="franprix",marques.G20="G20",marques["Intermarché Express"]="intermarche_express",marques.Monop="monop",marques["Petit Casino"]="petit_casino",marques.Shopi="shopi",marques.Sitis="sitis",marques["Supermarchés Coop"]="maxi",marques.Lidl="Lidl",angular.module("quiprendlesticketsGestionApp").constant("marques",marques),angular.module("quiprendlesticketsGestionApp").controller("MaincontrollerCtrl",["$scope","ENV","messageService",function(a,b,c){a.ENV=b,a.message=c.getMessage()}]),angular.module("quiprendlesticketsGestionApp").controller("SignupCtrl",["$scope","Auth","$location",function(a,b,c){a.register=function(d){b.createUser({email:a.user.email,username:a.user.username,password:a.user.password},function(b){a.errors={},b?angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.type}):c.path("/")})}}]),angular.module("quiprendlesticketsGestionApp").controller("LoginCtrl",["$scope","Auth","$location",function(a,b,c){a.error={},a.user={},a.login=function(d){b.login("password",{email:a.user.email,password:a.user.password},function(b){a.errors={},b?(angular.forEach(b.errors,function(b,c){d[c].$setValidity("mongoose",!1),a.errors[c]=b.type}),a.error.other=b.message):c.path("/")})}}]),angular.module("quiprendlesticketsGestionApp").factory("Auth",["$location","$rootScope","Session","User","$cookieStore",function(a,b,c,d,e){return b.currentUser=e.get("user")||null,e.remove("user"),{login:function(a,d,e){var f=e||angular.noop;c.save({provider:a,email:d.email,password:d.password,rememberMe:d.rememberMe},function(a){return b.currentUser=a,f()},function(a){return f(a.data)})},logout:function(a){var d=a||angular.noop;c.delete(function(){return b.currentUser=null,d()},function(a){return d(a.data)})},createUser:function(a,c){var e=c||angular.noop;d.save(a,function(a){return b.currentUser=a,e()},function(a){return e(a.data)})},currentUser:function(){c.get(function(a){b.currentUser=a})},changePassword:function(a,b,c,e){var f=e||angular.noop;d.update({email:a,oldPassword:b,newPassword:c},function(){return console.log("password changed"),f()},function(a){return f(a.data)})},removeUser:function(a,b,c){var e=c||angular.noop;d.delete({email:a,password:b},function(a){return console.log(a+"removed"),e()},function(a){return e(a.data)})}}}]),angular.module("quiprendlesticketsGestionApp").factory("Session",["$resource","ENV",function(a,b){return a(b.urlBackend+"/auth/session/",{})}]),angular.module("quiprendlesticketsGestionApp").factory("User",["$resource","ENV",function(a,b){return a(b.urlBackend+"/auth/users/:id/",{},{update:{method:"PUT"}})}]),angular.module("quiprendlesticketsGestionApp").directive("mongooseError",function(){return{restrict:"A",require:"ngModel",link:function(a,b,c,d){b.on("keydown",function(){return d.$setValidity("mongoose",!0)})}}}),angular.module("quiprendlesticketsGestionApp").constant("focusConfig",{focusClass:"focused"}).directive("onFocus",["focusConfig",function(a){return{restrict:"A",require:"ngModel",link:function(b,c,d,e){e.$focused=!1,c.bind("focus",function(){c.addClass(a.focusClass),b.$apply(function(){e.$focused=!0})}).bind("blur",function(){c.removeClass(a.focusClass),b.$apply(function(){e.$focused=!1})})}}}]),angular.module("quiprendlesticketsGestionApp").directive("uniqueUsername",["$http","ENV",function(a,b){return{restrict:"A",require:"ngModel",link:function(c,d,e,f){function g(c){return c?void a.get(b.urlBackend+"/auth/check_username/"+c).success(function(a){a.exists?f.$setValidity("unique",!1):f.$setValidity("unique",!0)}):void f.$setValidity("unique",!0)}c.$watch(function(){return f.$viewValue},g)}}}]),angular.module("quiprendlesticketsGestionApp").controller("NavCtrl",["$scope","$location","Auth",function(a,b,c){a.logout=function(){c.logout(function(a){a||b.path("/login")})}}]),angular.module("quiprendlesticketsGestionApp").factory("messageService",["$timeout",function(a){var b={message:{}};return{getMessage:function(){return b},setMessage:function(c){b.message=c,a(function(){b.message={}},5e3)}}}]),angular.module("quiprendlesticketsGestionApp").controller("MagasinsCtrl",["$scope","magasinService","marques","uiGridConstants",function(a,b){a.magasins=b.getMagasins(),a.magasins.infiniteScrollPercentage=15,a.magasins.multiSelect=!0,a.magasins.enableFiltering=!0,a.magasins.useExternalFiltering=!0,a.magasins.useExternalSorting=!0,a.magasins.columnDefs=[{name:"adresse",displayName:"Adresse",field:"properties.adresse"},{name:"carte",displayName:"Carte",enableFiltering:!1,enableSorting:!1,cellTemplate:'<div class="ui-grid-cell-contents cell-adresse"><img ng-src="https://maps.googleapis.com/maps/api/staticmap?center=46.52863469527167,2.43896484375&zoom=4&size=200x200&markers=color:red%7Clabel:%7C{{row.entity.geometry.coordinates[1]}},{{row.entity.geometry.coordinates[0]}}" lazy-src></div>'},{name:"marque.nom",displayName:"Marque",field:"properties.marque.nom"},{name:"Localisation (latitude, longitude)",enableFiltering:!1,enableSorting:!1,field:"geometry.coordinates"},{name:"actif",displayName:"Activé sur la carte",field:"properties.actif",cellFilter:"ouinon",enableFiltering:!1},{name:"Nombre de commentaires",field:"properties.commentaires.length",enableFiltering:!1,enableSorting:!1}],a.magasins.rowHeight=200,a.magasins.onRegisterApi=function(c){a.gridApi=c,a.gridApi.infiniteScroll.on.needLoadMoreData(a,function(){var a=b.getMoreMagasins();a.then(function(){c.infiniteScroll.dataLoaded()},function(){c.infiniteScroll.dataLoaded()})}),a.gridApi.core.on.filterChanged(a,function(){var a=this.grid,c=a.columns[1].filters[0].term;(angular.isUndefined(c)||null==c)&&(c="");var d=a.columns[3].filters[0].term;(angular.isUndefined(d)||null==d)&&(d="");var e={adresse:c,marque:d};b.setFilter(e),b.getMoreMagasins()}),a.gridApi.core.on.sortChanged(a,function(a,c){var d={};void 0!=c[0]&&(d[c[0].name]=c[0].sort.direction),b.setSort(d),b.getMoreMagasins()})}}]),angular.module("quiprendlesticketsGestionApp").factory("magasinService",["ENV","restService",function(a,b){var c={data:[]},d={adresse:"",marque:""},e={},f=1,g=function(){var g=b.getAppel({method:"GET",url:a.urlBackend+"/magasins",params:{filter:d,limit:100*f,sorts:e}});return g.then(function(a){c.data=a.data.features,++f}),g};return{getMagasins:function(){return g(),c},getMoreMagasins:function(){return g()},setFilter:function(a){d=a,f=1},setSort:function(a){e=a,f=1}}}]);